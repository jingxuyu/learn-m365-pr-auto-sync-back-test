Advanced hunting is a query-based threat-hunting tool that lets you explore up to 30 days of raw data. You can proactively inspect events in your network to locate threat indicators and entities. Flexible access to data enables unconstrained hunting for both known and potential threats. Exchange Online administrators with appropriate permissions can use advanced hunter to further inspect their messaging infrastructure.

### Data freshness and update frequency

Advanced hunting data can be categorized into two distinct types, each consolidated differently:

**Event or activity data**—populates tables about alerts, security events, system events, and routine assessments. Advanced hunting receives this data almost immediately after the sensors that collect them successfully transmit them to Defender for Endpoint.

**Entity data**—populates tables with consolidated information about users and devices. This data comes from both relatively static data sources and dynamic sources, such as Active Directory entries and event logs. To provide fresh data, tables are updated with any new information every 15 minutes, adding rows that might not be fully populated. Every 24 hours, data is consolidated to insert a record that contains the latest, most comprehensive data set about each entity.

### Email &amp; Collaboration Schema within advanced hunting:

EmailEvents table, examples of columns available with advanced hunter are:

 -  **Timestamp** \- Date and time when the event was recorded.
 -  **NetworkMessageId** \- Unique identifier for the email, generated by Microsoft 365.
 -  **InternetMessageId** \- Public-facing identifier for the email that is set by the sending email system.
 -  **SenderMailFromAddress** \- Sender email address in the MAIL FROM header, also known as the envelope sender or the Return-Path address.
 -  **SenderFromAddress** \- Sender email address in the FROM header, which is visible to email recipients on their email clients.
 -  **SenderDisplayName** \- Name of the sender displayed in the address book, typically a combination of a given or first name, a middle initial, and a last name or surname.
 -  **SenderObjectId** \- Unique identifier for the sender's account in Azure AD.
 -  **SenderMailFromDomain** \- Sender domain in the MAIL FROM header, also known as the envelope sender or the Return-Path address.
 -  **SenderFromDomain** \- Sender domain in the FROM header, which is visible to email recipients on their email clients.
 -  **AuthenticationDetails** \- List of pass or fail verdicts by email authentication protocols like DMARC, DKIM, SPF or a combination of multiple authentication types (CompAuth).

For a full list of available columns within the EmailEvents table, see [EmailPostDeliveryEvents table in the advanced hunting schema](/microsoft-365/security/defender/advanced-hunting-emailpostdeliveryevents-table?azure-portal=true).

EmailPostDeliveryEvents, examples of columns available with advanced hunter are:

 -  **Timestamp** \- Date and time when the event was recorded.
 -  **NetworkMessageId** \- Unique identifier for the email, generated by Microsoft 365.
 -  I**nternetMessageId** \- Public-facing identifier for the email that is set by the sending email system.
 -  **Action** \- Action taken on the entity.
 -  **ActionType** \- Type of activity that triggered the event: Manual remediation, Phish ZAP, Malware ZAP.
 -  **ActionTrigger** \- Indicates whether an action was triggered by an administrator (manually or through approval of a pending automated action), or by some special mechanism, such as a ZAP or Dynamic Delivery.
 -  **ActionResult** \- Result of the action.
 -  **RecipientEmailAddress** \- Email address of the recipient, or email address of the recipient after distribution list expansion.
 -  **DeliveryLocation** \- Location where the email was delivered: Inbox/Folder, On-premises/External, Junk, Quarantine, Failed, Dropped, Deleted items.
 -  **ReportId** \- Event identifier based on a repeating counter. To identify unique events, this column must be used with the DeviceName and Timestamp columns.
 -  **ThreatTypes** \- Verdict from the email filtering stack on whether the email contains malware, phishing, or other threats.
 -  **DetectionMethods** \- Methods used to detect malware, phishing, or other threats found in the email.

EmailUrlInfo, examples of columns available with advanced hunter are:

 -  **Timestamp** \- Date and time when the event was recorded.
 -  **NetworkMessageId** \- Unique identifier for the email, generated by Microsoft 365.
 -  **Url** \- Full URL in the email subject, body, or attachment.
 -  **UrlDomain** \- Domain name or host name of the URL.

EmailAttachmentInfo, examples of columns available with advanced hunter are:

 -  **FileName** \- Name of the file that the recorded action was applied to.
 -  **FileType** \- File extension type.
 -  **ThreatTypes** \- Verdict from the email filtering stack on whether the email contains malware, phishing, or other threats.
 -  **ThreatNames** \- Detection name for malware or other threats found.
 -  **DetectionMethods** \- Methods used to detect malware, phishing, or other threats found in the email.
 -  **FileSize** \- Size of the file in bytes.

For a full list of available columns within the EmailAttachmentInfo table, see [EmailAttachmentInfo table in the advanced hunting schema](/microsoft-365/security/defender/advanced-hunting-emailattachmentinfo-table?azure-portal=true).

### Custom detections

With custom detections, you can proactively monitor for and respond to various events and system states, including suspected breach activity and misconfigured devices. You can do this with customizable detection rules that automatically trigger alerts and response actions.

Custom detections work with advanced hunting, which provides a powerful, flexible query language that covers a broad set of event and system information from your network. You can set them to run at regular intervals, generate alerts, and take response actions whenever there are matches.

Custom detections provide:

 -  Alerts for rule-based detections built from advanced hunting queries.
 -  Automatic response actions.

### Create detection rules

Before you can manage or review detection rules, you must ensure that you have the following permissions assigned:

 -  For Full access, the messaging admin must be a member of Organization Management or Security Administrator role groups.
 -  For Read-Only access, the messaging admin must be a member of the Global Reader or Security Reader role groups.

To create detection rules:

**1. Prepare the query.**

In Microsoft Defender Security Center, go to Advanced hunting and select an existing query or create a new query. When using a new query, run the query to identify errors and understand possible results.

\[!IMPORTANT\] To prevent the service from returning too many alerts, each rule is limited to generating only 100 alerts whenever it runs. Before creating a rule, tweak your query to avoid alerting for normal, day-to-day activity.

To use a query for a custom detection rule, the query must return the following columns:

 -  Timestamp
 -  ReportId
 -  A column that identifies a specific device, user, or mailbox. For example:
    
     -  DeviceId
     -  RecipientEmailAddress
     -  SenderFromAddress
     -  SenderMailFromAddress
     -  AccountUpn

Simple queries, such as those that don't use the project or summarize operator to customize or aggregate results, typically return these common columns.

The sample query below attempts to identify potential exfiltration scenarios with querying outbound emails with large attachment sizes.

```
EmailEvents 
| where EmailDirection == "Outbound" and AttachmentCount > 0 
| join EmailAttachmentInfo on NetworkMessageId, RecipientEmailAddress
| where toint(FileSize) > 10000 
```

**2. Create a new rule and provide alert details.**

With the query in the query editor, select Create detection rule and specify the following alert details:

 -  Detection name - name of the detection rule.
 -  Frequency - interval for running the query and taking action. See more guidance below.
 -  Alert title - title displayed with alerts triggered by the rule.
 -  Severity - potential risk of the component or activity identified by the rule.
 -  Category - type of threat component or activity, if any.
 -  MITRE ATT&amp;CK techniques - one or more attack techniques identified by the rule as documented in the MITRE ATT&amp;CK framework. This section isn't available with certain alert categories, such as malware, ransomware, suspicious activity, and unwanted software.
 -  Description - more information about the component or activity identified by the rule.
 -  Recommended actions - extra actions that responders might take in response to an alert.

**3. Choose the impacted entities.**

Identify the columns in your query results where you expect to find the main affected or impacted entity. For example, a query might return sender (SenderFromAddress or SenderMailFromAddress) and recipient (RecipientEmailAddress) addresses. Identifying which of these columns represent the main impacted entity helps the service aggregate relevant alerts, correlate incidents, and target response actions.

You can select only one column for each entity type. Columns that aren't returned by your query can't be selected.

**4. Specify actions.**

Your custom detection rule can automatically take actions on files or devices that are returned by the query.

Actions on devices:

These actions are applied to devices in the DeviceId column of the query results:

 -  Isolate device - applies full network isolation, preventing the device from connecting to any application or service, except for the Defender for Endpoint service.
 -  Collect investigation package - collects device information in a ZIP file.
 -  Run antivirus scan - performs a full Microsoft Defender Antivirus scan on the device.
 -  Initiate investigation - starts an automated investigation on the device.

Actions on files:

When selected, you can choose to apply a **Quarantine file** action on files in the SHA1, InitiatingProcessSHA1, SHA256, or InitiatingProcessSHA256 column of the query results. This action deletes the file from its current location and places a copy in quarantine.

Actions on users:

When selected, the **Mark user as compromised** action is taken on users in the AccountObjectId, InitiatingProcessAccountObjectId, or RecipientObjectId column of the query results. This action sets the users risk level to "high" in Azure Active Directory.

**5. Set the rule scope.**

Set the scope to specify which devices are covered by the rule. The scope influences rules that check devices and doesn't affect rules that check only mailboxes and user accounts or identities. You can select:

 -  All devices
 -  Specific device groups

Only data from devices in scope will be queried. Also, actions will be taken only on those devices.

**6. Review and turn on the rule.**

After reviewing the rule, select **Create** to save it. The custom detection rule immediately runs. It runs again based on configured frequency to check for matches, generate alerts, and take response actions.
