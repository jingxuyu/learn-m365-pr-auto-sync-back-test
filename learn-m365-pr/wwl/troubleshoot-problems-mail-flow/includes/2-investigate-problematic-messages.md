We've probably all experienced issues where a message we send can't be delivered. In this unit, we'll learn how to investigate those issues.

## Identify types of NDRs and interpret NDR data

When investigating possible causes of delivery failure, it's worth considering the following:

- The recipient email address is incorrectly entered, or incorrectly stored in an address list.
- The message contains elements, such as an attachment, that exceed a configured limitation, such as maximum attachment size.

After eliminating these possible causes, you'll need to investigate further. A useful investigative tool to use and review are non-delivery reports (NDRs). These reports are generated by Exchange Online (and other messaging systems) when a message cannot be delivered. NDRs contain codes that can help identify the cause of delivery failure.

Exchange Online generates a graphical email that's returned to the sender. This email contains suggestions on how the user might attempt to resolve the issue in addition to NDR codes to identify the cause of the issue for an administrator. In the following screenshot, an NDR email is displayed. The cause of the failure to deliver is clearly identified at the top of the message. In this case, it's failed because the recipient doesn't exist at the destination domain. Exchange also suggests checking and retyping the address.

:::image type="content" source="../media/non-delivery-report-1.png" alt-text="A screenshot of an NDR message as described in the preceding text.":::

In the second screenshot, the message displays a specific status code, in this case 550 5.4.1. Additional information is displayed about the cause, along with suggestions for a solution.

:::image type="content" source="../media/non-delivery-report-2.png" alt-text="A screenshot of an NDR message as described in the preceding text, with the additional information about the cause.":::

The `docs.microsoft.com` website contains several documents that describe each status code in more detail and provide detailed analysis of possible causes and suggested troubleshooting steps and mitigations. For example, the following document describes the 5.4.1 status code displayed in the preceding email message NDR: [Fix email delivery issues for error code 550 5.4.1 in Exchange Online](/exchange/mail-flow-best-practices/non-delivery-reports-in-exchange-online/fix-error-code-550-5-4-1-in-exchange-online).

The following table describes some of the more common NDR status codes.

| NDR status code| Description|
| :--- | :--- |
| 5.1.1| **Bad destination mailbox address.** This code probably means the sender has entered the wrong email address for the intended recipient, and the entered address doesn't exist in the target domain.|
| 5.2.x| **Submission quota exceeded**. The sender has exceeded a limit on the number of messages that can be sent to a recipient. There are several status codes that might apply, and each is slightly different.|
| 5.4.1| **Recipient address rejected: Access denied**. This code means that the recipientÂ´s address doesn't exist.|
| 5.7.x| **Delivery not authorized**. There are several status codes with this prefix, but all are related to the sender, or the sending system not being permitted to send messages to the recipient.|

> [!TIP]
> As a support engineer, you should be familiar with common NDR status codes. Review the Learn more links at the end of this unit to discover a full list of NDR status codes and a description of their meaning, together with suggested mitigations.

Interpretation of an NDR requires careful study of the information in the returned email message. Typical NDRs contain several sections:

- **User information**. Appears at the top of an NDR message and provides basic summary information of the issue.
- **Diagnostic information**. Appears next in the NDR message and provides more technical insights into the problem.
- **Original message headers**. Appears at the end of the NDR message and provides verbose information about the message communications process.

The following text is a sample from an NDR.

```
User information:

Delivery has failed to these recipients or groups:

nonexistent@contoso.com

Your message wasn't delivered due to a permission or security issue. It might have been rejected by a moderator, the address might only accept email from certain senders, or another restriction might be preventing delivery. The following organization rejected your message: mail.contoso.com.

Diagnostic information for administrators:

Generating server: alpineskihouse.com

nonexistent@contoso.com

mail.contoso.com #<exchange.contoso.com #5.7.1 smtp;530 5.7.1 Client was not authenticated> #SMTP#

Original message headers:

...
```

From the **User information** section, at the top, you can determine that the recipient is a user called `Non Existent`, and that the message was rejected by the mail server `mail.contoso.com`, which isn't an Exchange Online mail server.

From the **Diagnostic information** for administrators' section, you can see that `alpineskihouse.com` attempted to connect to the server `mail.contoso.com` to deliver the message to the recipient `nonexistent@contoso.com`. However, mail.contoso.com responded with the error **530 5.7.1 Client was not authenticated**.

The NDR was generated by the sending mail server, but `mail.contoso.com` rejected the message. This information means that the mail administrators at contoso.com are responsible for understanding and fixing the problem.

> [!NOTE]
> This error indicates that the server `mail.contoso.com` is configured not to accept anonymous email from the Internet.

## Review and interpret message headers

In addition to the User information and Diagnostic information, you can scroll further down your NDR message and locate the original message details, error details, and the message hops the message took to its destination. This information is displayed in the following screenshot.

:::image type="content" source="../media/non-delivery-report-3.png" alt-text="A screenshot of the Original Message Details section of an email NDR.":::

This information can provide clues as to the possible cause of the problem. For example, the Message Hops can identify the SMTP hosts used to route a message. These hosts might be experiencing outages, be misconfigured, or even be blocking your organization's SMTP host (although not in this case).

Further down the NDR message, you can locate the Original Message Headers section, displayed in the following screenshot.

:::image type="content" source="../media/non-delivery-report-4.png" alt-text="A screenshot of a portion of the Original Message Header section of an email NDR.":::

You can usually extract helpful information from the header fields described in the following table.

| Field| Description|
| :--- | :--- |
| To| This field might be helpful if the email address was mistyped.|
| Received| These fields can tell you what the path was for the message, and the last hop that generated the delivery status notification if it isn't easy to tell from the Generating server value in the NDR.|
| Received-SPF| If this value is anything other than pass, check the Sender Policy Framework (SPF) DNS record for your domain. For more information, see **Determine whether SPF, DMARC, and DKIM records are valid** in unit 4 of this module.|

You can also use the Message Header Analyzer tool to help analyze the headers:

1. In Microsoft Edge, navigate to the Microsoft Remote Connectivity Analyzer website: [https://testconnectivity.microsoft.com/tests/exchange](https://testconnectivity.microsoft.com/tests/exchange).
1. Select **Message Analyzer** in the navigation pane. A new tab opens.
1. In the **Message Header Analyzer**, in the **Insert the message header you would like to analyze** section, paste the entirety of the message header from your message.
1. Click **Analyze headers**.

You can now more easily make sense of the message header data, as displayed in the following screenshot. The screenshot displays the inserted header data at the top, and beneath it, the detailed analysis. Summary information is shown, and beneath that, more detailed information about what's contained in the header.

:::image type="content" source="../media/message-header-analyzer.png" alt-text="A screenshot displays the Message Header Analyzer.":::

## Troubleshoot send or receive email issues when no NDR is generated

If your users experience problems sending or receiving email, and they're not receiving NDRs, you must rely on your own investigative skills to determine the cause.

A way of narrowing down the possible causes is to pose the standard troubleshooting questions:

- **Is anyone else affected?** If not, then it suggests it's an issue related to the user (authentication, licensing, configuration), their device, or their mailbox settings.
- **Has anything recently changed?** If so, then review any recent configuration changes, such as mailbox policies or transport rules.
- **Is the user doing something differently?** For example, if the user can successfully send and receive email using Outlook desktop client for Windows, which is what they usually use, but cannot use their iOS Outlook app, which they've never used before, then it's likely related to Azure Active Directory (Azure AD) Conditional Access policies, Device Access Rules or perhaps the user's email app settings.

The following section describes a common approach to investigating email delivery issues.

1. If more than one user has issues, then review Office 365 service health issues for Exchange Online
1. If only one user has issues, then:

    1. Check the configuration of Outlook or other email app
    1. If Outlook desktop is OK, but the user has problems with mobile device mail flow, review the following settings:

        - Review Device Access Rules
        - Review Azure AD Conditional Access policies
        - Review mobile device access states
        - Review quarantine status of mobile devices
        - Review Client Access Rules

    1. Run the email delivery troubleshooter

        > [!TIP]
        > Select **Diag: Troubleshoot Email Delivery** to launch the diagnostic in the Microsoft 365 admin center. Enter the email address of the sender and recipient in addition to other relevant information, and then select **Run Tests**.

    1. Use message trace to perform in-depth email delivery troubleshooting

## Review and interpret message trace results

If users report problems with delays in email delivery, you can use message trace to attempt to diagnose the problem. By using message trace, you can:

- Follow messages as they pass through your Exchange Online service.
- Determine whether a targeted email message was:

    - Received
    - Rejected
    - Deferred
    - Delivered

- Identify events that have occurred to the message before it reached its final status.

You can access message trace from the Exchange admin center. 

1. In the navigation pane, select **Mail flow**, and then select **Message trace**.
1. In the Message trace pane, you can choose to run some standard traces. These are:

    - Messages sent from my primary domain in the last day
    - Messages received by my primary domain in the last day
    - Messages pending delivery to users in my organization
    - All quarantined messages for the last 7 days
    - All failed messages for the last 7 days

1. To run one of these traces, select it from the list. A new blade opens, as shown in the following screenshot.

    :::image type="content" source="../media/trace-1.png" alt-text="A screenshot displays the New message trace blade. The details are from the standard 'All failed messages for the last 7 days' trace.":::

1. Click **Search**. Your trace runs and the results are displayed. 
1. In the results window, select any message you want to review. The details for the message trace is displayed, as shown in the following screenshot.

    :::image type="content" source="../media/trace-2.png" alt-text="A screenshot of a message trace for an email that failed to deliver. The Status, Error, and How to fix it fields are visible. ":::

1. Scroll down through the trace to locate more in-depth analysis. In the **Message events** section, shown below, you can review the various stages of the message's journey.

    :::image type="content" source="../media/trace-3.png" alt-text="A screenshot displays the Message events section of a message trace. ":::

## Learn more

- [Message trace in the modern Exchange admin center in Exchange Online](/exchange/monitoring/trace-an-email-message/message-trace-modern-eac)
- [Email non-delivery reports in Exchange Online](/exchange/mail-flow-best-practices/non-delivery-reports-in-exchange-online/non-delivery-reports-in-exchange-online)
- [Fix email delivery issues for error code 550 5.4.1 in Exchange Online](/exchange/mail-flow-best-practices/non-delivery-reports-in-exchange-online/fix-error-code-550-5-4-1-in-exchange-online)
