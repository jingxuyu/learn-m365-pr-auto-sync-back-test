Windows Server Active Directory Federation Services (AD FS) can be deployed on Azure virtual machines, and the recommendations for an on-premises AD FS deployment apply equally to an AD FS deployment on Azure. However, because some of the recommendations, such as load balancing and high availability, require technologies beyond what AD FS offers, they must be provided by the underlying infrastructure. 

The following list outlines some of those best practices and how they can be achieved by using Azure VMs and an Azure VNet:

 -  **Deploy Active Directory domain controllers for all user domains in the same network as the AD FS servers.** AD FS servers use Active Directory Domain Service to authenticate users. Domain controllers should be deployed on the same network as the AD FS servers. This design not only provides business continuity in case the link between the Azure network and your on-premises network breaks, but it also enables lower latency and increased performance for logins.
 -  **Deploy multiple AD FS nodes for high availability and balancing the load.** In most cases, the failure of an application that AD FS enables is unacceptable because the applications that require security tokens are often critical for an organization. Because AD FS is required to access mission critical applications, the AD FS service must be highly available through multiple AD FS proxies and AD FS servers. To achieve distribution of requests, load balancers are typically deployed in front of both the AD FS Proxies and the AD FS servers.
 -  **Deploy one or more Web Application Proxy nodes for internet access.** When users access applications protected by the AD FS service, it must be available from the internet. Organizations should also deploy more than one node for the purposes of high availability and load balancing. This design is achieved by deploying the Web Application Proxy service.
 -  **Never expose security token service (STS) servers directly to the Internet.** This design is important because the STS role issues security tokens. As a result, STS servers such as AD FS servers should be treated with the same level of protection as a domain controller. If an STS is compromised, malicious users can issue access tokens that potentially contain claims of their choosing to relying party applications and other STS servers in trusting organizations.
 -  **Restrict access from the Web Application Proxy nodes to internal network resources.** To allow external users to access AD FS from the internet, an organization must deploy Web Application Proxy nodes (or AD FS Proxy in earlier versions of Windows Server). The Web Application proxy nodes are directly exposed to the Internet. They aren't required to be domain-joined, and they only need access to the AD FS servers over TCP ports 443 and 80. It's recommended that an organization block communication to all other computers (especially domain controllers), which is typically achieved on-premises with a perimeter network. Firewalls use an allowlist mode of operation to restrict traffic from the perimeter network to the on-premises network (that is, only traffic from the specified IP addresses and over specified ports is allowed, and all other traffic is blocked). The following diagram shows how this design looks in a traditional on-premises AD FS deployment.

:::image type="content" source="../media/traditional-adfs-deployment-9bf26014.png" alt-text="graphic showing a traditional on-premises AD FS deployment - that is, an organizational network with a perimeter network, firewall, and web application proxy nodes that allow external users to access ADFS from the internet":::


There is another alternative to deploying AD FS altogether if an organization's goal is only to enable single sign-on for Microsoft 365. In that case, Directory Synchronization with password hash synchronization can be deployed on-premises. This design achieves the same end-result with minimal deployment complexity because it doesn't require AD FS or Azure.

### Other considerations when planning for AD FS

The following list provides a summary of other considerations when planning a federated authentication solution using AD FS:

 -  If an organization deploys AD FS proxy on an Azure virtual machine, connectivity to the AD FS servers is needed. If they're on-premises, it's recommended that you use the site-to-site VPN connectivity provided by the virtual network to allow the Web Application Proxy nodes to communicate with their AD FS servers.
 -  If an organization deploys an AD FS server on an Azure virtual machine, connectivity to Windows Server Active Directory domain controllers, Attribute Stores, and Configuration databases is necessary. It may also require an ExpressRoute or a site-to-site VPN connection between the Azure Virtual Network and the on-premises network.
 -  Charges are applied to all traffic from Azure virtual machines (egress traffic). If cost is the driving factor, it's advisable to deploy the Web Application Proxy nodes on Azure, leaving the AD FS servers on-premises. If the AD FS servers are also deployed on Azure virtual machines, more costs will be incurred to authenticate on-premises users. Egress traffic incurs a cost regardless of whether it's traversing the ExpressRoute or the VPN site-to-site connection.
 -  If an organization uses Azure’s native server load-balancing capabilities for high availability of AD FS servers, load balancing provides probes that determine the health of the virtual machines within the cloud service. For Azure virtual machines (as opposed to web or worker roles), a custom probe must be used since the agent that responds to the default probes isn't present on Azure virtual machines. For simplicity, a custom TCP probe can be used. This type of probe only requires the establishment of a successful TCP connection (a TCP SYN segment sent and responded to with a TCP SYN ACK segment) to determine virtual machine health. The custom probe can be configured to use any TCP port to which an organization's virtual machines are actively listening. For more information, see [Tutorial: Load balance Windows virtual machines in Azure to create a highly available application with Azure PowerShell](/azure/virtual-machines/windows/tutorial-load-balancer).

## Knowledge check<br>

Choose the best response for the following question. Then select “Check your answers.”