Anti-malware and anti-spam defenses are a critical part of any modern messaging system. Microsoft 365 provides highly effective tools for minimizing the number of unwanted messages that reach user mailboxes while providing strong defenses against malicious software.

Exchange Online uses several anti-spam technologies to minimize incoming spam messages. It scans incoming messages and stores the results in the Anti-spam Message Headers that are part of every SMTP message. Additionally, it saves the spam confidence level (SCL) as part of this header; the SCL includes the likeliness that the message is spam.

When Microsoft Exchange Online Protection (EOP) scans an incoming message, it inserts an X-Forefront-Antispam-Report header (X-header) into the SMTP header of the message. Fields in this header enable you to gather information about the message and how it was processed.

Microsoft provides tools like the Remote Connectivity Analyzer (RCA) that can be used to translate the email header information to understand how Exchange Online Protection is processing emails.

Microsoft Exchange Online Protection provides the following filters that can be configured to protect your organization’s messaging system:

 *  Malware filtering
 *  Connection filtering
 *  Spam filtering

The RCA tool [is available here](https://aka.ms/RCA?azure-portal=true).

**Additional reading.** See the following site for an in-depth explanation of the [Exchange Online plans](https://aka.ms/edx-cld222x-eohttps://aka.ms/RCA?azure-portal=true) and the anti-spam features available in each.

### Configuring malware filtering

Exchange Online uses the malware protection in EOP to protect user mailboxes against infected messages. EOP uses multiple industry-leading malware detection engines to scan incoming and outgoing mail, with these engines being updated as new virus definitions appear.

In the Exchange Admin Center (EAC) and the Security and Compliance Center, you can configure anti-malware policies to protect against malware in Microsoft 365. An anti-malware policy is a combination of two elements:

 *  A malware policy that defines what happens when malware is detected.
 *  A malware rule that defines who the policy applies to.

Exchange Online comes with a preconfigured malware filter that simply deletes the message without providing any notifications. This policy, which applies to everyone, can be edited but not deleted. You also can't change who the policy applies to.

If during your planning, you identify that your company needs different protection arrangements for different internal groups, then you can add one or more anti-malware policies and then fine-tune the settings to meet the identified requirements.

You configure malware filters through the protection settings in the EAC or by using Windows PowerShell. When using Windows PowerShell, you need to configure rules and policies separately.

Policies are applied in order from the highest priority down to the lowest. When you've saved the new policy and any other policies, you can change each policy’s priority, which controls the order in which the policy is applied. The default policy is always the lowest priority and provides a final barrier that simply deletes the offending messages.

To configure a malware policy with PowerShell, use the **New-MalwareFilterPolicy** command. To configure a malware rule that applies a policy to users, groups, or domains, use the **New-MalwareFilterRule** command.

### Configuring connection filtering

Both Exchange Online and the Security and Compliance Center provide a connection filter that enables you to configure filtering based on IP addresses, with separate “IP allow” and “IP block” lists. Unlike malware filters, there's only one default connection filter, but you can customize its settings.

IP allow-lists are typically addresses or ranges that you trust, while IP block lists are for addresses or even subnets of known spammers from which you don't want to receive messages. You can also enable a safe list. This option enables acceptance of messages that are from known senders. Microsoft uses third-party sources to supply the list of safe senders.

Settings that you can change are:

 *  Allowed IP addresses
 *  Blocked IP addresses
 *  Enable safe list

With both IP allow-lists and IP block lists, you can specify individual addresses or network ranges using Classless Inter-Domain Routing (CIDR). CIDR is a method for allocating IP addresses that is more flexible than the original system of Internet Protocol (IP) address classes because it removes the class A, B, and C subnet masks.

The Allow setting typically overrides the Block setting. As a result, if you add an address to both lists, mail is allowed from that IP address. The SCL is automatically set to -1 for IP addresses on the IP allow-list, which means the message skips all further processing. You can add or remove connection filters either in the EAC or through Windows PowerShell.

To configure connection filters using Windows PowerShell, you need to use the **Set-HostedConnectionFilterPolicy** cmdlet. For example, if you want to configure the allow-list to add the IPs 192.168.1.100 and192.169.3.1 through 192.169.3.199, and remove the IP address 192.168.99.22, you must run the following cmdlet:

```
Set-HostedConnectionFilterPolicy "Default" -IPAllowList @{Add="192.168.1.100","192.169.3.1-192.169.3.99";Remove="192.168.99.22"}
```

> [!NOTE]
> This tool is effective for catching all traffic from the IP addresses in the block lists; however, it may not be the most effective way to protect your environment given your company’s needs. For more information, see the following article on [Configuring EOP best practices](https://technet.microsoft.com/library/jj723164%28v=exchg.150%29.aspxhttps://aka.ms/RCA?azure-portal=true).

### Configuring spam filtering

Spam filters are the main component against malware or other harmful email attachments that want to grab your personal information from your computer. Spam filters provide a range of basic and advanced filtering options, automatically add spam processing headers, and assign a spam confidence level to the messages before delivery to user mailboxes.

Configuration settings for spam filters fall into the following categories:

 *  General (name, description)
 *  Spam and bulk actions
 *  IP Allow lists
 *  IP Block lists
 *  International spam
 *  Advanced options
 *  Applied to

The default spam filter policy applies to all messages and all mailboxes. You can then add other spam filter policies that apply different settings to separate groups and sets the application order of those policies.
