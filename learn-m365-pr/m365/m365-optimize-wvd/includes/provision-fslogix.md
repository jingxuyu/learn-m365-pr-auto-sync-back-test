You can use **FSLogix profiles** to separate user profiles from virtual machines, persist these profiles as user-assigned virtual disks in Azure storage, and then dynamically attach them to a user. Each time the user signs in to a remote desktop or remote app, their profile is attached to the resource, and they're able to access all of their data.  

Compared to classic roaming user profiles in Windows, separating the user profiles and data enables a seamless roaming experience for apps that rely on %localappdata% locations – like Outlook and OneDrive. It's fast and stateful - as far as users can tell, their data loads as fast as locally stored data. FSLogix profiles let you use cached mailboxes for local-like access to email and OneDrive Files on Demand. 

## Set up storage space for dynamic user profiles

1. Create a storage account in the Azure portal to store the user-assigned virtual disk files generated by the FSLogix profiles. The process works by containerizing the user profile into a VHD or VHDX file the first time a user signs in. The VHD or VHDX files are stored to this location and then attached to users in subsequent logins.  

   To create the **Storage account**, search for or click on "Storage Accounts" in the Azure portal. Click the **+** sign, then select a **Resource Group**. Give it a name, configure any additional fields as necessary, and click **Next**. Then **Review** and click **Create**. 
2. Enable Azure Active Directory authentication for Azure Files for the new storage account. In **Configuration** enable the **Azure Active Directory Authentication** option. 
3. Create a custom Azure role to manage storage on behalf of your users. You can do thisin Azure Cloud Shell or PowerShell.  
   1. Start by defining a configuration JSON file with the required variables. (You can see a sample file at [https://aka.ms/MechWVDScriptSamples](https://aka.ms/MechWVDScriptSamples)). Give your role a name, like "AFReadWriteRole," and add your unique subscription ID:  

      ```
      { 
         "Name": "AFReadWriteRole",
         "Id": null,
         "IsCustom": true,
         "Description": "Allows for read, write and delete access to Azure File Share over SMB",
         "Actions": [ 
            "Microsoft.Storage/storageAccounts/fileServices/*"
            ],
         "DataActions": [
            "Microsoft.Storage/storageAccounts/fileServices/*"
            ],
         "NotDataActions": [
            "Microsoft.Storage/storageAccounts/fileServices/fileshares/files/modifypermissions/action",
            "Microsoft.Storage/storageAccounts/fileServices/fileshares/files/actassuperuser/action"
            ],
         "AssignableScopes": [
            "/subscriptions/[Azure Subscription ID]"
            ]
         }
       ``` 
 
   2. Next, in an elevated PowerShell window, import and install your Azure Storage and Azure Resources modules. Then use **New-AZRoleDefintion** to set the JASON file as the InputFile file:

      ```powershell
      New-AzRoleDefinition -InputFile “C:\Path\AFReadWriteRole.json” 
      ```
   3. Now in your new storage account, create a file share to store the user profile virtual disks. Go to **Files**, add a **File Share**, give it a **Name** and a **Storage Quota** in Gibibytes (GiB), up to 5120 GiB. Click **Create**. This file share will use SMB 3.0 protocol with your session hosts. 
4. In PowerShell, assign a user to the **AZReadWriteRole** you created in the previous step:
   ```powershell
   $FileShareContributorRole = Get-AzRoleDefinition "AFReadWriteRole"$scope = "/subscriptions/[subscriptionID]/resourceGroups/[Resource Group]/providers/Microsoft.Storage/storageAccounts/[storageaccount]/fileServices/default/fileshare/[filesharename]"  
   
   New-AzRoleAssignment -SignInName [UPN_Email] -RoleDefinitionName $FileShareContributorRole.Name -Scope $scope
   ``` 
   In "scope" add your subscription ID, resource group name, storage account, and the name of the file share created in the previous step.  

5. Now use the **New-AzRoleAssignment** cmdlet for all the accounts that will use an FSLogix virtual disk. This can be a single or multiple user principal names (UPNs).
6. Any VM you create using a gallery image has the FSLogix software preinstalled. If you used an image NOT from the gallery, you need to install FSLogix:
   1. Start by adding two registry keys to the VM for FSLogix. Create a key for them first called **Profiles**.  
   2. Within that new key, add a **DWORD** called "Enabled" and set its value to "1."  
   3. Add a **Multi-String value** called "VHDLocations" and add the file share location from Azure Files, in SMB path format. You can find the location in your storage account properties. Find the Service Endpoint and convert it from an HTTP path to an SMB path. 
   4. Finally, from an elevated command prompt, run the following commands. (You can find the required access keys in **Azure Storage Account > Settings > Access Keys**.)  
      ```
      net use Z: [converted SMB path used in VHDLocations in the registry] [Access Key]

      Icacls Z: /grant [End user UPN]:(f)
      ```
   
      >[!NOTE]
      > To create the FSLogix profile, the VM can't already have a user profile established for the user. 

7. Now, go to [https://aka.ms/wvdweb](https://aka.ms/wvdweb) and sign in to a VM you've not yet signed into. The initial sign-in will take a little longer than usual. This is a one-time delay while the process creates the virtual disk file in the background. This is the file that will be used each time you sign in.  

   Go back to your **Storage Account** in Azure, and navigate to the **File Share**. You’ll see a new virtual disk. 

The next time the user signs in, the VM will connect to their virtual disk. For the user, it will feel like any apps that use %localappdata% are using a locally stored profile.