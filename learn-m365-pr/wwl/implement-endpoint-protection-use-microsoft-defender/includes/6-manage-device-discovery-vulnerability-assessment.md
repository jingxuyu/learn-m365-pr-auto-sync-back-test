Protecting your environment requires taking inventory of the devices that are in your network. However, mapping devices in a network can often be expensive, challenging, and time-consuming.

Microsoft Defender for Endpoint provides a device discovery capability that helps an organization find unmanaged devices connected to its corporate network. It completes this discovery process without the need for extra appliances or cumbersome process changes. Device discovery uses onboarded endpoints to collect, probe, and scan the network to discover unmanaged devices. The device discovery capability enables organizations to discover:

 -  Enterprise endpoints (workstations, servers and mobile devices) that aren't yet onboarded to Microsoft Defender for Endpoint.
 -  Network devices like routers and switches.
 -  IoT devices like printers and cameras.

Unknown and unmanaged devices introduce significant risks to a network. It doesn't matter whether it's an unpatched printer, network devices with weak security configurations, or a server with no security controls.

Once devices are discovered, an organization can:

 -  Onboard unmanaged endpoints to the service, increasing the security visibility on them.
 -  Reduce the attack surface by identifying and assessing vulnerabilities, and detecting configuration gaps.

**Additional viewing**. Select the following link to watch a short video that introduces [device discovery](https://www.microsoft.com/videoplayer/embed/RWORdQ?postJsllMsg=true?azure-portal=true).

A security recommendation to onboard devices to Microsoft Defender for Endpoint is also available as part of the Threat and Vulnerability Management module.

### Discovery methods

An organization can choose the discovery mode to be used by its onboarded devices. The mode controls the level of visibility you can get for unmanaged devices in your corporate network.

There are two modes of discovery available:

 -  **Basic discovery**. In this mode, endpoints passively collect events in a network and extract device information from them. Basic discovery uses the **SenseNDR.exe** binary for passive network data collection. No network traffic is initiated. Endpoints just extract data from every network traffic that is seen by an onboarded device. With basic discovery, you'll only gain limited visibility of unmanaged endpoints in your network.
 -  **Standard discovery (recommended)**. This mode enables endpoints to actively find devices in a network to enrich collected data and discover more devices. This process helps organizations build a reliable and coherent device inventory. In addition to devices that were observed using the passive method, standard mode also applies common discovery protocols that use multicast queries in the network. This process finds even more devices. Standard mode uses smart, active probing to discover more information about observed devices to enrich existing device information. When Standard mode is enabled, minimal and negligible network activity generated by the discovery sensor may be observed by an organization's network monitoring tools.

Standard discovery is the default mode for all customers starting July 2021. You can choose to change this configuration to basic through the **Settings** page. If you choose basic mode, you'll only gain limited visibility of unmanaged endpoints in your network.

Organizations can change and customize their discovery settings. For more information, see [Configure device discovery](/microsoft-365/security/defender-endpoint/configure-device-discovery?azure-portal=true).

The discovery engine distinguishes between network events that are received in the corporate network versus outside of the corporate network. Devices that aren't connected to corporate networks won't be discovered or listed in the device inventory.

### Device inventory

Devices that have been discovered but haven't been onboarded and secured by Microsoft Defender for Endpoint will be listed in the device inventory within the **Microsoft Endpoint Manager admin center**.

To assess these devices, you can use a filter in the device inventory list called **Onboarding status**. This filter can have any of the following values:

 -  **Onboarded**. The endpoint is onboarded to Microsoft Defender for Endpoint.
 -  **Can be onboarded**. The endpoint was discovered in the network. The Operating System was identified as one that's supported by Microsoft Defender for Endpoint. However, the device has yet to be onboarded. It's recommended that these devices be onboarded as soon as possible.
 -  **Unsupported**. The endpoint was discovered in the network but isn't supported by Microsoft Defender for Endpoint.
 -  **Insufficient information**. The system couldn't determine the supportability of the device. Enabling standard discovery on more devices in the network can enrich the discovered attributes.

You can always apply filters to exclude unmanaged devices from the device inventory list. You can also use the onboarding status column on API queries to filter out unmanaged devices.

**Additional reading**. For more information, see [Device inventory](/microsoft-365/security/defender-endpoint/machines-view-overview?azure-portal=true).

### Network device discovery

The large number of unmanaged network devices deployed in an organization creates a large surface area of attack. They also represent a significant risk to the entire enterprise. The network discovery capability within Microsoft Defender for Endpoint helps organizations ensure their network devices are discovered, accurately classified, and added to their asset inventory.

Network devices aren't managed as standard endpoints. Why? Because Microsoft Defender for Endpoint doesn't have a sensor built into the network devices themselves. Instead, these types of devices require an agentless approach where a remote scan obtains the necessary information from the devices. To gather this information, a designated Microsoft Defender for Endpoint device will be used on each network segment to perform periodic authenticated scans of preconfigured network devices. The Threat and Vulnerability Management capability within Microsoft Defender for Endpoint then provides integrated workflows to secure the following discovered information:

 -  switches
 -  routers
 -  WLAN controllers
 -  firewalls
 -  VPN gateways

**Additional reading**. For more information, see [Network devices](/microsoft-365/security/defender-endpoint/network-devices?azure-portal=true).

### Device discovery integrations

Microsoft Defender for Endpoint addresses the challenge of gaining enough visibility for organizations to locate, identify, and secure their complete OT/IOT asset inventory. It does so by supporting the following integrations:

 -  **Corelight**. Microsoft has partnered with Corelight to receive data from Corelight network appliances. This design provides Microsoft 365 Defender with increased visibility into the network activities of unmanaged devices. This visibility includes communication with other unmanaged devices or external networks. For more information, see Enable Corelight data integration.
 -  **Microsoft Defender for IoT**. This integration combines the device discovery capabilities within Microsoft Defender for Endpoint with the agentless monitoring capabilities of Microsoft Defender for IoT. This integration secures enterprise IoT devices connected to an IT network. For example, Voice over Internet Protocol (VoIP), printers, and smart TVs. For more information, see [Enable Microsoft Defender for IoT integration](/microsoft-365/security/defender-endpoint/enable-microsoft-defender-for-iot-integration?azure-portal=true).

### Configure device discovery

As previously noted, device discovery can be configured to be on standard or basic mode. Organizations should use the standard option to actively find devices in their networks. This option will better guarantee the discovery of endpoints and provide richer device classification.

An organization can customize the list of devices that are used to perform standard discovery. It can either enable standard discovery on all the onboarded devices that also support this capability (currently - Windows 10 or later and Windows Server 2019 or later devices only) or select a subset or subsets of your devices by specifying their device tags.

Complete the following steps to set up device discovery:

1.  Navigate to the **Microsoft 365 Defender** portal.
2.  In the navigation pane in the **Microsoft 365 Defender** portal, select **Settings**, and then select **Device discovery**.
3.  If you want to configure Basic as the discovery mode to use on your onboarded devices, select **Basic** and then select **Save.**
4.  If you've selected to use Standard discovery, select one of the following options to determine which devices to use for active probing:
     -  all devices
     -  a subset of devices by specifying their device tags
5.  Select **Save**.

> [!NOTE]
> Standard discovery uses various PowerShell scripts to actively probe devices in the network. Those PowerShell scripts are Microsoft signed and are executed from the following location: C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\\\*.ps. For example, C:\\ProgramData\\Microsoft\\Windows Defender Advanced Threat Protection\\Downloads\\UnicastScannerV1.1.0.ps1.

### Exclude devices from being actively probed in standard discovery

Some organizations have devices on their network that shouldn't be actively scanned. For example, devices that are used as honeypots for another security tool. In these cases, an organization can define a list of exclusions to prevent these devices from being scanned. You can configure the devices to exclude in the Exclusions page.

> [!NOTE]
> Devices can still be discovered using Basic discovery mode. They can also be discovered through multicast discovery attempts. Those devices will be passively discovered but won't be actively probed.

### Select networks to monitor

When Microsoft Defender for Endpoint analyzes a network, it determines if the network is:

 -  a corporate network that must be monitored.
 -  a non-corporate network that can be ignored.

To identify a network as corporate, Microsoft Defender for Endpoint correlates network identifiers across all tenant's clients. If the majority of the devices in the organization report that they're connected to the same network name, with the same default gateway and DHCP server address, it's assumed the network is a corporate network. Corporate networks are typically chosen to be monitored. However, you can override this decision by choosing to monitor non-corporate networks where onboarded devices are found.

An organization can configure where device discovery can be performed. It does so by specifying which networks to monitor. When a network is monitored, device discovery can be performed on it.

> [!NOTE]
> A list of networks where device discovery can be performed is shown in the **Monitored networks** page. The list shows networks that were identified as corporate networks. If less than 50 networks are identified as corporate networks, then list will show up to 50 networks with the most onboarded devices.

The list of monitored networks is sorted based upon the total number of devices seen on the network in the last seven days.

A filter can be applied to view any of the following network discovery states:

 -  **Monitored networks**. Networks where device discovery is performed.
 -  **Ignored networks**. This network will be ignored and device discovery won't be performed on it.
 -  **All**. Both monitored and ignored networks will be displayed.

### Configure the network monitor state

Organizations can control where device discovery takes place. Monitored networks are where device discovery will be performed. These networks are typically corporate networks. You can also choose to ignore networks or select the initial discovery classification after modifying a state.

 -  Selecting the initial discovery classification means to apply the default system-made network monitor state.
 -  Selecting the default system-made network monitor state means that:
     -  networks that were identified to be corporate will be monitored.
     -  networks that were identified as non-corporate will be automatically ignored.

Complete the following steps to configure the network monitor state:

1.  Navigate to the **Microsoft 365 Defender** portal.
2.  In the navigation pane in the **Microsoft 365 Defender** portal, select **Settings**, and then select **Device discovery**.
3.  On the **Device discovery** page, select **Monitored networks.**
4.  View the list of networks. Select the ellipsis icon (three dots) next to the name of the network that you want to monitor.
5.  Choose whether you want to monitor, ignore, or use the initial discovery classification. Keep in mind the following considerations:
     -  Choosing to monitor a network that was not identified by Microsoft Defender for Endpoint as a corporate network can cause device discovery outside of your corporate network. As such, it may detect home or other non-corporate devices.
     -  Choosing to ignore a network will stop monitoring and discovering devices in that network. Devices that were already discovered won't be removed from the inventory. However, they will no longer be updated, and details will be retained until the data retention period of the Microsoft Defender for Endpoint expires.
     -  Before choosing to monitor non-corporate networks, you must ensure you have permission to do so.
6.  Confirm that you want to make the change.

### Explore devices in the network

You can use the following advanced hunting (Kusto) query to get more context about each network name described in the networks list. The query lists all the onboarded devices that were connected to a certain network within the last seven days.

```
DeviceNetworkInfo
| where Timestamp > ago(7d)
| where ConnectedNetworks != ""
| extend ConnectedNetworksExp = parse_json(ConnectedNetworks)
| mv-expand bagexpansion = array ConnectedNetworks=ConnectedNetworksExp
| extend NetworkName = tostring(ConnectedNetworks ["Name"]), Description = tostring(ConnectedNetworks ["Description"]), NetworkCategory = tostring(ConnectedNetworks ["Category"])
| where NetworkName == "<your network name here>"
| summarize arg_max(Timestamp, *) by DeviceId
```

### Get information on device

You can use the following advanced hunting (Kusto) query to get the latest complete information on a specific device.

```
DeviceInfo
| where DeviceName == "<device name here>" and isnotempty(OSPlatform)
| summarize arg_max(Timestamp, *) by DeviceId
```

### Vulnerability assessment on discovered devices

Vulnerabilities and risks on your devices as well as other discovered unmanaged devices in the network are part of the current Threat and Vulnerabilities Management flows under "Security Recommendations". They're represented in entity pages across the portal. For example, search for "SSH" related security recommendations (SSH stands for Secure Shell, a widely adopted protocol for secure communications over an untrusted network). The purpose of the search is to find SSH vulnerabilities that are related for unmanaged and managed devices.

### Use advanced hunting on discovered devices

Organizations can use advanced hunting queries to gain visibility on discovered devices. Find details about discovered devices in the DeviceInfo table, or network-related information about those devices in the DeviceNetworkInfo table.

Run the following query on the DeviceInfo table to return all discovered devices. The results will also display the latest details for each device.

```
DeviceInfo
| summarize arg_max(Timestamp, *) by DeviceId // Get latest known good per device ID
| where isempty(MergedToDeviceId) // Remove invalidated/merged devices
| where OnboardingStatus != "Onboarded"
```

By invoking the SeenBy function in your advanced hunting query, you can get detail on which onboarded device a discovered device was seen by. This information can help determine the network location of each discovered device. It can then help to identify it in the network.

```
DeviceInfo
| where OnboardingStatus != "Onboarded"
| summarize arg_max(Timestamp, *) by DeviceId 
| where isempty(MergedToDeviceId) 
| limit 100
| invoke SeenBy()
| project DeviceId, DeviceName, DeviceType, SeenBy
```

### Query network related information

Device discovery uses Microsoft Defender for Endpoint onboarded devices as a network data source to attribute activities to non-onboarded devices. The network sensor on the Microsoft Defender for Endpoint onboarded device identifies two new connection types:

 -  **ConnectionAttempt**. An attempt to establish a TCP connection.
 -  **ConnectionAcknowledged**. An acknowledgment that a TCP connection was accepted.

When a non-onboarded device attempts to communicate with an onboarded Microsoft Defender for Endpoint device, the attempt will:

 -  generate a DeviceNetworkEvent.
 -  display the non-onboarded device activities on the onboarded device timeline and through the Advanced hunting DeviceNetworkEvents table.

You can try this example query:

```
DeviceNetworkEvents
| where ActionType == "ConnectionAcknowledged" or ActionType == "ConnectionAttempt"
| take 10
```
